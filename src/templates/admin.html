{% extends "base.html" %}

{% block title_content %}
    <title>Amministratore</title>
{% endblock %}

{% block script_content %}
<script>
    window.onload = updatePage;
    var timestamps;
    function callSave() {
        return new Promise(function(resolve, reject) {
            var saveRequest = new XMLHttpRequest();
            saveRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            saveRequest.open("POST", "/save", true);
            saveRequest.send();
        })
    }
    function callLoad(timestamp) {
        return new Promise(function(resolve, reject) {
            var loadRequest = new XMLHttpRequest();
            loadRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            loadRequest.open("POST", "/load", true);
            loadRequest.setRequestHeader("Content-Type", "application/json");
            json_content = Object();
            json_content['timestamp'] = timestamp;
            loadRequest.send(JSON.stringify(json_content));
        })
    }
    function callDownload(timestamp) {
        return new Promise(function(resolve, reject) {
            var downloadRequest = new XMLHttpRequest();
            downloadRequest.responseType = "blob";
            downloadRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.response);
                    } else {
                        reject(this.response);
                    }
                }
            };
            downloadRequest.open("POST", "/download", true);
            downloadRequest.setRequestHeader("Content-Type", "application/json");
            json_content = Object();
            json_content['timestamp'] = timestamp;
            downloadRequest.send(JSON.stringify(json_content));
        })
    }
    function callGetTimestamps() {
        return new Promise(function(resolve, reject) {
            var timestampsRequest = new XMLHttpRequest();
            timestampsRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            timestampsRequest.open("GET", "/load", true);
            timestampsRequest.send();
        })
    }
    function updatePage() {
        Promise.all([callGetTimestamps()]).then(function (values) {
            timestamps = JSON.parse(values[0]);
            updateChoice();
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function updateChoice() {
        choice = document.getElementById("saved");
        choice.options.length = 0;
        for (key in timestamps) {
            option = document.createElement("option");
            option.value = key;
            option.innerText = timestamps[key];
            choice.appendChild(option);
        }
    }
    function pickleSave() {
        Promise.all([callSave()]).then(function (values) {
            timestamp = JSON.parse(values[0]);
            timestamps = {...timestamps, ...timestamp};
            updateChoice();
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function pickleLoad() {
        choice = document.getElementById("saved");
        index = choice.value;
        Promise.all([callLoad(timestamps[index])]).then(function (values) {
            window.alert("Loading successful");
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function pickleDownload() {
        choice = document.getElementById("saved");
        index = choice.value;
        Promise.all([callDownload(timestamps[index])]).then(function (values) {
            var blob = new Blob([values[0]], {type: "application/octet-stream"});
            var url = window.URL.createObjectURL(blob);
            var link = document.createElement('a');
            document.body.appendChild(link);
            link.style = "display:none";
            link.href = url;
            link.download = 'save_' + timestamps[index] + '.dat';
            link.click();
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                link.remove();
            }, 100);
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
</script>
{% endblock %}

{% block content %}
<a href="/web/leagues">Leghe</a>
<a href="/web/nations">Nazioni</a>
<a href="/web/players">Tennisti</a>
<a href="/web/gamblers">Scomettitori</a>
<button type="button" onclick="pickleSave()">Salva</button>
<select name="saved" id="saved"></select>
<button type="button" onclick="pickleLoad()">Recupera</button>
<button type="button" onclick="pickleDownload()">Download</button>
{% endblock %}
