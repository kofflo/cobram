{% extends "base.html" %}

{% block title_content %}
    <title></title>
{% endblock %}

{% block script_content %}
<script>
    window.onload = updatePage;
    var leagues;
    var gamblers;
    var players;
    var nations;
    var ranking;
    var tournaments;
    function callLeagues() {
        return new Promise(function(resolve, reject) {
            var leaguesRequest = new XMLHttpRequest();
            leaguesRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            leaguesRequest.open("GET", "/leagues", true);
            leaguesRequest.send();
        })
    }
    function callGamblers() {
        return new Promise(function(resolve, reject) {
            var gamblersRequest = new XMLHttpRequest();
            gamblersRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            gamblersRequest.open("GET", "/gamblers", true);
            gamblersRequest.send();
        })
    }
    function callPlayers() {
        return new Promise(function(resolve, reject) {
            var playersRequest = new XMLHttpRequest();
            playersRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            playersRequest.open("GET", "/players", true);
            playersRequest.send();
        })
    }
    function callNations() {
        return new Promise(function(resolve, reject) {
            var nationsRequest = new XMLHttpRequest();
            nationsRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            nationsRequest.open("GET", "/nations", true);
            nationsRequest.send();
        })
    }
    function callRanking() {
        return new Promise(function(resolve, reject) {
            var rankingRequest = new XMLHttpRequest();
            rankingRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            rankingRequest.open("GET", "/leagues/{{ league_index }}/ranking", true);
            rankingRequest.send();
        })
    }
    function callTournaments() {
        return new Promise(function(resolve, reject) {
            var tournamentsRequest = new XMLHttpRequest();
            tournamentsRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            tournamentsRequest.open("GET", "/leagues/{{ league_index }}/tournaments", true);
            tournamentsRequest.send();
        })
    }
    function updatePage() {
        Promise.all([callLeagues(), callGamblers(), callPlayers(), callNations(), callRanking(), callTournaments()]).then(function (values) {
            leagues = JSON.parse(values[0]);
            gamblers = JSON.parse(values[1]);
            players = JSON.parse(values[2]);
            nations = JSON.parse(values[3]);
            ranking = JSON.parse(values[4]);
            tournaments = JSON.parse(values[5]);
            updateTitles();
            updateTableTournaments();
            updateTablesRanking();
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function updateTitles() {
        document.getElementById("mainHeader").innerText = leagues["{{ league_index }}"]["name"];
        document.getElementById("winnerLeague").innerText = "Vincitore\n" + leagues["{{ league_index }}"]["name"];
        document.title = leagues["{{ league_index }}"]["name"];
    }
    function updateTableTournaments() {
        table = document.getElementById("tableTournamentsBody");
        index = 0;
        for (var key in tournaments) {
            {% if not is_privileged %}
            if (tournaments[key]["is_ghost"]) {
                continue;
            }
            {% endif %}
            const row = table.insertRow();
            const name_cell = row.insertCell();
            name_link = document.createElement("a");
            name_link.innerText = tournaments[key]["name"];
            name_link.setAttribute("href", "/web/leagues/{{ league_index }}/tournaments/" + index);
            name_cell.appendChild(name_link);
            const year_cell = row.insertCell();
            year_cell.innerText = tournaments[key]["year"];
            const nation_code_cell = row.insertCell();
            nation_code_cell.innerText = nations[tournaments[key]["nation"]].code;
            const flag_cell = row.insertCell();
            const img = document.createElement('img');
            img.src = '/static/flags/' + nations[tournaments[key]["nation"]].code + '.png';
            img.setAttribute("class", "bordered");
            flag_cell.appendChild(img);
            const n_sets_cell = row.insertCell();
            n_sets_cell.innerText = tournaments[key]["n_sets"];
            const tie_breaker_cell = row.insertCell();
            tie_breaker = tournaments[key]["tie_breaker_5th"];
            if (tie_breaker == "TIE_BREAKER_AT_7") {
                tie_breaker_cell.innerText = "Tie-break sul 6-6";
            } else if (tie_breaker == "TIE_BREAKER_AT_13") {
                tie_breaker_cell.innerText = "Tie-break sul 12-12";
            } else if (tie_breaker == "NO_TIE_BREAKER") {
                tie_breaker_cell.innerText = "Senza tie-break";
            }
            const category_cell = row.insertCell();
            category = tournaments[key]["category"];
            if (category == "GRAND_SLAM") {
                category_cell.innerText = "GRAND SLAM";
            } else if (category == "MASTER_1000") {
                category_cell.innerText = "MASTER 1000";
            } else if (category == "ATP_FINALS") {
                category_cell.innerText = "ATP FINALS";
            } else if (category == "OLYMPICS") {
                category_cell.innerText = "OLIMPIADI";
            } else if (category == "ATP_500") {
                category_cell.innerText = "ATP 500";
            } else if (category == "ATP_250") {
                category_cell.innerText = "ATP 250";
            }
            const draw_cell = row.insertCell();
            draw = tournaments[key]["draw_type"];
            if (draw == "Draw16") {
                draw_cell.innerText = "Eliminazione-16"
            } else if (draw == "DrawRoundRobin") {
                draw_cell.innerText = "Round Robin";
            }
            const player_winner_cell = row.insertCell();
            const player_winner = tournaments[key]["winner"] != null ? players[tournaments[key]["winner"]] : null;
            if (player_winner != null) {
                player_winner_cell.innerText = player_winner["name"] + " " + player_winner["surname"];
            } else {
                player_winner_cell.innerText = "/";
            }
            const gambler_winner_cell = row.insertCell();
            const gambler_winner = key in ranking["winners"] ? gamblers[ranking["winners"][key]] : null;
            if (gambler_winner != null) {
                gambler_winner_cell.innerText = gambler_winner["nickname"];
            } else {
                gambler_winner_cell.innerText = "/";
            }
            {% if is_privileged %}
                const ghost_cell = row.insertCell();
                if (tournaments[key]["is_ghost"]) {
                    ghost_cell.innerText = "GHOST";
                }
            {% endif %}
            index += 1;
        }
    }
    function updateTablesRanking() {
        table = document.getElementById("tableRankingBody");
        ranking_scores = ranking["ranking_scores"];
        ranking_scores_array = Object.entries(ranking_scores);
        ranking_scores_array.sort(function(first_pair, second_pair) {
            return first_pair[1] - second_pair[1];
        });
        ranking_scores_array.reverse();
        for (index = 0; index < ranking_scores_array.length; index++) {
            const pair = ranking_scores_array[index];
            const row = table.insertRow();
            const position_cell = row.insertCell();
            position_cell.innerText = index + 1;
            const gambler_cell = row.insertCell();
            gambler_cell.innerText = gamblers[pair[0]]["nickname"];
            const points_cell = row.insertCell();
            points_cell.innerText = pair[1];
        }
        table = document.getElementById("tableRaceBody");
        yearly_scores = ranking["yearly_scores"];
        years = Object.keys(yearly_scores).map(x => parseInt(x));
        if (years.length == 0) {
            document.getElementById("tableRace").remove();
            return;
        }
        last_year = Math.max(...years);
        document.getElementById("raceTitle").innerText = "Race " + last_year;
        yearly_scores_array = Object.entries(yearly_scores[last_year]);
        yearly_scores_array.sort(function(first_pair, second_pair) {
            return first_pair[1] - second_pair[1];
        });
        yearly_scores_array.reverse();
        for (index = 0; index < yearly_scores_array.length; index++) {
            const pair = yearly_scores_array[index];
            const row = table.insertRow();
            const position_cell = row.insertCell();
            position_cell.innerText = index + 1;
            const gambler_cell = row.insertCell();
            gambler_cell.innerText = gamblers[pair[0]]["nickname"];
            const points_cell = row.insertCell();
            points_cell.innerText = pair[1];
        }
    }
    {% if is_privileged %}
    var forms;
    function newTournament() {
        table = document.getElementById("tournamentInsert");
        table.hidden = false;
        row = table.insertRow();
        row.insertCell().innerText = "Nome";
        row.insertCell().innerText = "Anno";
        row.insertCell().innerText = "Nazione";
        row.insertCell().innerText = "Set";
        row.insertCell().innerText = "Tie-break al 5° set";
        row.insertCell().innerText = "Categoria";
        row.insertCell().innerText = "Tabellone";
        row.insertCell().innerText = "Ghost";
        row = table.insertRow();
        forms = Object();
        name_cell = row.insertCell();
        let form_name = document.createElement("input");
        form_name.setAttribute("type", "text");
        form_name.setAttribute("size", 15);
        name_cell.appendChild(form_name);
        forms["name"] = form_name;
        year_cell = row.insertCell();
        let form_year = document.createElement("input");
        form_year.setAttribute("type", "text");
        form_year.setAttribute("size", 3);
        form_year.value = new Date().getFullYear();
        year_cell.appendChild(form_year);
        forms["year"] = form_year;
        nation_cell = row.insertCell();
        let form_nation = document.createElement("select");
        for (key in nations) {
            if (nations[key]["name"] == "BYE") {
                continue;
            }
            option = document.createElement("option");
            option.value = key;
            option.innerText = nations[key]["name"];
            form_nation.appendChild(option);
        }
        nation_cell.appendChild(form_nation);
        forms["nation"] = form_nation;
        set_cell = row.insertCell();
        let form_set = document.createElement("select");
        addOptions(form_set, [3, 5]);
        set_cell.appendChild(form_set);
        forms["n_sets"] = form_set;
        tie_break_cell = row.insertCell();
        let form_tie_break = document.createElement("select");
        form_tie_break.disabled = true;
        function set_change() {
            if (form_set.value == 3) {
                form_tie_break.disabled = true;
            } else {
                form_tie_break.disabled = false;
            }
        }
        form_set.onchange = set_change;
        addOptions(form_tie_break, ["Tie-break sul 6-6", "Tie-break sul 12-12", "Senza tie-break"]);
        tie_break_cell.appendChild(form_tie_break);
        forms["tie_breaker_5th"] = form_tie_break;
        category_cell = row.insertCell();
        let form_category = document.createElement("select");
        addOptions(form_category, ["GRAND SLAM", "MASTER 1000", "ATP FINALS", "OLIMPIADI", "ATP 500", "ATP 250"]);
        category_cell.appendChild(form_category);
        forms["category"] = form_category;
        draw_cell = row.insertCell();
        let form_draw = document.createElement("select");
        addOptions(form_draw, ["Eliminazione-16", "Round Robin"]);
        draw_cell.appendChild(form_draw);
        forms["draw_type"] = form_draw;
        ghost_cell = row.insertCell();
        let form_ghost = document.createElement("input");
        form_ghost.type = "checkbox";
        function ghost_change() {
            if (form_ghost.checked == true) {
                form_nation.disabled = true;
                form_set.disabled = true;
                form_tie_break.disabled = true;
                form_category.disabled = true;
                form_draw.disabled = true;
            } else {
                form_nation.disabled = false;
                form_set.disabled = false;
                form_tie_break.disabled = form_set.value == 3;
                form_category.disabled = false;
                form_draw.disabled = false;
            }
        }
        form_ghost.onchange = ghost_change;
        ghost_cell.appendChild(form_ghost);
        forms["ghost"] = form_ghost;
        button = document.getElementById("tournamentButton");
        button.innerText = "Invia";
        button.onclick = sendTournament;
        cancelButton = document.createElement("button");
        cancelButton.id = "cancelButton";
        cancelButton.innerText = "Annulla";
        cancelButton.onclick = restoreTournaments;
        button.parentNode.insertBefore(cancelButton, button.nextSibling);
    }
    function sendTournament() {
        requestJson = Object();
        requestJson["name"] = forms["name"].value.trim();
        requestJson["year"] = forms["year"].value.trim();
        requestJson["nation_index"] = forms["nation"].value;
        requestJson["n_sets"] = 3;//forms["n_sets"].value;
        requestJson["tie_breaker_5th"] = null;//forms["tie_breaker_5th"].value;
        requestJson["category"] = "MASTER_1000";//forms["category"].value;
        requestJson["draw_type"] = "Draw16";//forms["draw_type"].value;
        requestJson["previous_year_scores"] = null;
        requestJson["ghost"] = forms["ghost"].checked;

//        row.insertCell().innerText = "Set";
//        row.insertCell().innerText = "Tie-break al 5° set";
//        row.insertCell().innerText = "Categoria";
//        row.insertCell().innerText = "Tabellone";
//        row.insertCell().innerText = "Ghost";

        Promise.all([sendTournamentRequest(requestJson)]).then(function (values) {
            new_tournament = JSON.parse(values[0]);
            for (key in new_tournament) {
                tournaments[key] = new_tournament[key];
            }
            restoreTournaments();
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function sendTournamentRequest(requestJson) {
        return new Promise(function (resolve, reject) {
            var postRequest = new XMLHttpRequest();
            postRequest.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            postRequest.open("POST", "/leagues/{{ league_index }}/tournaments", true);
            postRequest.setRequestHeader("Content-Type", "application/json");
            postRequest.send(JSON.stringify(requestJson));
        })
    }
    function sendDeleteRequest(index) {
        return new Promise(function (resolve, reject) {
            var deleteRequest = new XMLHttpRequest();
            deleteRequest.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            deleteRequest.open("DELETE", "/leagues/{{ league_index }}/tournaments/" + index, true);
            deleteRequest.send();
        })
    }
    function restoreTournaments() {
        button = document.getElementById("tournamentButton");
        button.innerText = "Crea un torneo";
        button.onclick = newTournament;
        document.getElementById("cancelButton").remove();
        document.getElementById("tournamentInsert").innerText = "";
        document.getElementById("tournamentInsert").hidden = true;
        forms = Object();
        updateTableTournaments();
    }
    function addOptions(form, array) {
        for (index in array) {
            option = document.createElement("option");
            option.value = array[index];
            option.innerText = array[index];
            form.appendChild(option);
        }
    }
    {% endif %}
</script>
{% endblock %}

{% block content %}
<h1 id="mainHeader"></h1>
<table id="tournamentInsert" hidden="true"></table>
{% if is_privileged %}
<button id="tournamentButton" onclick="newTournament()">Crea un torneo</button>
{% endif %}
<div id="tournamentDiv">
    <h2>Tornei</h2>
    <table class="styled-table">
        <thead>
        <tr>
            <td>Nome</td>
            <td>Anno</td>
            <td>Nazione</td>
            <td>Bandiera</td>
            <td>Set</td>
            <td>Tie-break al 5° set</td>
            <td>Categoria</td>
            <td>Tabellone</td>
            <td>Vincitore</td>
            <td id="winnerLeague"></td>
            {% if is_privileged %}
                <td>Ghost</td>
            {% endif %}
        </tr>
        </thead>
        <tbody id="tableTournamentsBody">
        </tbody>
    </table>
</div>
<div>
    <div class="floatRankings">
        <h2>Ranking</h2>
        <table class="styled-table">
            <thead>
            <tr>
                <td>Posizione</td>
                <td>Scommettitore</td>
                <td>Punti</td>
            </tr>
            </thead>
            <tbody id="tableRankingBody">
            </tbody>
        </table>
    </div>
    <div class="floatRankings">
    <h2 id="raceTitle"></h2>
        <table id="tableRace" class="styled-table">
            <thead>
            <tr>
                <td>Posizione</td>
                <td>Scommettitore</td>
                <td>Punti</td>
            </tr>
            </thead>
            <tbody id="tableRaceBody">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
