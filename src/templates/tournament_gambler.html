{% extends "base.html" %}

{% block title_content %}
    <title></title>
{% endblock %}

{% block script_content %}
<script>
    window.onload = updatePage;
    window.mobileCheck = function() {
        let check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
    };
    var leagues;
    var gamblers;
    var players;
    var nations;
    var ranking;
    var tournaments;
    var tournamentPlayers;
    var matches;
    var bets;
    function callLeagues() {
        return new Promise(function(resolve, reject) {
            var leaguesRequest = new XMLHttpRequest();
            leaguesRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            leaguesRequest.open("GET", "/leagues", true);
            leaguesRequest.send();
        })
    }
    function callGamblers() {
        return new Promise(function(resolve, reject) {
            var gamblersRequest = new XMLHttpRequest();
            gamblersRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            gamblersRequest.open("GET", "/gamblers", true);
            gamblersRequest.send();
        })
    }
    function callPlayers() {
        return new Promise(function(resolve, reject) {
            var playersRequest = new XMLHttpRequest();
            playersRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            playersRequest.open("GET", "/players", true);
            playersRequest.send();
        })
    }
    function callNations() {
        return new Promise(function(resolve, reject) {
            var nationsRequest = new XMLHttpRequest();
            nationsRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            nationsRequest.open("GET", "/nations", true);
            nationsRequest.send();
        })
    }
    function callRanking() {
        return new Promise(function(resolve, reject) {
            var rankingRequest = new XMLHttpRequest();
            rankingRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            rankingRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/ranking", true);
            rankingRequest.send();
        })
    }
    function callTournaments() {
        return new Promise(function(resolve, reject) {
            var tournamentsRequest = new XMLHttpRequest();
            tournamentsRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            tournamentsRequest.open("GET", "/leagues/{{ league_index }}/tournaments", true);
            tournamentsRequest.send();
        })
    }
    function callTournamentPlayers() {
        return new Promise(function(resolve, reject) {
            var tournamentPlayersRequest = new XMLHttpRequest();
            tournamentPlayersRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            tournamentPlayersRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/players", true);
            tournamentPlayersRequest.send();
        })
    }
    function callMatches() {
        return new Promise(function(resolve, reject) {
            var matchesRequest = new XMLHttpRequest();
            matchesRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            matchesRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/matches", true);
            matchesRequest.send();
        })
    }
    function callBets() {
        return new Promise(function(resolve, reject) {
            var betsRequest = new XMLHttpRequest();
            betsRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            betsRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/gamblers/{{ gambler_index }}/matches", true);
            betsRequest.send();
        })
    }
    function updatePage() {
        Promise.all([callLeagues(), callGamblers(), callPlayers(), callNations(), callRanking(), callTournaments(), callTournamentPlayers(), callMatches(), callBets()]).then(function (values) {
            leagues = JSON.parse(values[0]);
            gamblers = JSON.parse(values[1]);
            players = JSON.parse(values[2]);
            nations = JSON.parse(values[3]);
            ranking = JSON.parse(values[4]);
            tournaments = JSON.parse(values[5]);
            tournamentPlayers = JSON.parse(values[6]);
            matches = JSON.parse(values[7]);
            bets = JSON.parse(values[8]);
            updateTitles();
            updateMatches();
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function updateTitles() {
        document.getElementById("mainHeader").innerText = gamblers[{{ gambler_index }}]["nickname"];
        subHeaderLink = document.createElement("a");
        subHeaderLink.innerText = tournaments[{{ tournament_index }}]["name"] + "  " + tournaments[{{ tournament_index }}]["year"];
        subHeaderLink.setAttribute("href", "/web/leagues/{{ league_index }}/tournaments/{{ tournament_index }}");
        subHeader = document.getElementById("subHeader");
        subHeader.innerHTML = "";
        subHeader.appendChild(subHeaderLink);
        points = "Punti: " + ranking["tournament_scores"][{{ gambler_index }}] + "   (Jolly finale: " + ranking["joker_gambler_seed_points"][{{ gambler_index }}] + ")";
        document.getElementById("pointsHeader").innerText = points;
        document.title = tournaments[{{ tournament_index }}]["name"] + "  " + tournaments[{{ tournament_index }}]["year"];
    }
    function updateMatches() {
        table = document.getElementById("matches");
        table.innerText = "";
        any_open_match = false;
        for (var key in matches) {
            const row = table.insertRow();
            const id_cell = row.insertCell();
            id_cell.innerText = key;
            if (matches[key]["bets_closed"]) {
                lock = document.createElement("img");
                lock.src = "/static/lock.png";
                id_cell.innerText += "   ";
                id_cell.appendChild(lock);
            } else {
                any_open_match = true;
            }
            const player_1_cell = row.insertCell();
            const player_2_cell = row.insertCell();
            const score_cell = row.insertCell();
            const joker_cell = row.insertCell();
            const points_cell = row.insertCell();
            if (matches[key]["players"]["player_1"] == null || matches[key]["players"]["player_2"] == null) {
                continue;
            }
            seed_player_1 = getSeed(matches[key]["players"]["player_1"]);
            if (seed_player_1 != 0) {
                seed_string = " [" + seed_player_1 + "]";
            } else {
                seed_string = "";
            }
            player_1_cell.innerText = players[matches[key]["players"]["player_1"]]["surname"] + seed_string;
            seed_player_2 = getSeed(matches[key]["players"]["player_2"]);
            if (seed_player_2 != 0) {
                seed_string = " [" + seed_player_2 + "]";
            } else {
                seed_string = "";
            }
            player_2_cell.innerText = players[matches[key]["players"]["player_2"]]["surname"] + seed_string;
            score_cell.innerText = formatScore(bets[key]["score"]);
            if (bets["joker"] == key) {
                const joker_image = document.createElement("img");
                joker_image.src = '/static/star.png';
                joker_cell.appendChild(joker_image);
            }
            if (matches[key]["bets_closed"]) {
                points_cell.innerText = bets[key]["points"];
            }
        }
        if (!any_open_match) {
            button = document.getElementById("betsButton");
            button.hidden = true;
        }
    }
    function getSeed(player) {
        for (key in tournamentPlayers) {
            if (tournamentPlayers[key] == null) {
                continue;
            }
            index = tournamentPlayers[key]["index"];
            if (index == player) {
                return tournamentPlayers[key]["seed"];
            }
        }
    }
    function formatScore(score) {
        formatted = "";
        for (set in score) {
            if (score[set][0] == -1) {
                formatted += "A- " + " / ";
            } else if (score[set][1] == -1) {
                formatted += " -A" + " / ";
            } else {
                formatted += score[set][0] + "-" + score[set][1] + " / ";
            }
        }
        return formatted.slice(0, -2);
    }
    function formatScoreForm(score) {
        formatted = "";
        for (set in score) {
            if (score[set][0] == -1) {
                formatted += "A- ";
            } else if (score[set][1] == -1) {
                formatted += "-A ";
            } else if (score[set][0] < 10 && score[set][1] < 10) {
                formatted += String(score[set][0]) + String(score[set][1]) + " ";
            } else {
                formatted += score[set][0] + "-" + score[set][1] + " ";
            }
        }
        return formatted;
    }
    {% if is_privileged %}
    var forms = Object();
    var checkboxes = Object();
    function insertBets() {
        button = document.getElementById("betsButton");
        button.innerText = "Manda i punteggi";
        button.onclick = sendBets;
        cancelButton = document.createElement("button");
        cancelButton.id = "cancelButton";
        cancelButton.innerText = "Annulla";
        cancelButton.onclick = restoreMatches;
        button.parentNode.insertBefore(cancelButton, button.nextSibling);
        table = document.getElementById("matches");
        table.innerText = "";
        for (var key in matches) {
            const row = table.insertRow();
            const id_cell = row.insertCell();
            id_cell.innerText = key;
            if (matches[key]["bets_closed"]) {
                lock = document.createElement("img");
                lock.src = "/static/lock.png";
                id_cell.innerText += "   ";
                id_cell.appendChild(lock);
            }
            const player_1_cell = row.insertCell();
            const player_2_cell = row.insertCell();
            const score_cell = row.insertCell();
            const joker_cell = row.insertCell();
            const points_cell = row.insertCell();
            if (matches[key]["players"]["player_1"] == null || matches[key]["players"]["player_2"] == null) {
                continue;
            }
            seed_player_1 = getSeed(matches[key]["players"]["player_1"]);
            if (seed_player_1 != 0) {
                seed_string = " [" + seed_player_1 + "]";
            } else {
                seed_string = "";
            }
            player_1_cell.innerText = players[matches[key]["players"]["player_1"]]["surname"] + seed_string;
            seed_player_2 = getSeed(matches[key]["players"]["player_2"]);
            if (seed_player_2 != 0) {
                seed_string = " [" + seed_player_2 + "]";
            } else {
                seed_string = "";
            }
            player_2_cell.innerText = players[matches[key]["players"]["player_2"]]["surname"] + seed_string;
            if (matches[key]["bets_closed"]) {
                score_cell.innerText = formatScore(bets[key]["score"]);
                if (bets["joker"] == key) {
                    const joker_image = document.createElement("img");
                    joker_image.src = '/static/star.png';
                    joker_cell.appendChild(joker_image);
                }
                points_cell.innerText = bets[key]["points"];
            } else {
                inner_table = document.createElement("table");
                inner_table.setAttribute("class", "forms-table");
                inner_row = inner_table.insertRow();
                forms[key] = Object();
                if (!window.mobileCheck()) {
                    // desktop
                    for (var set = 0; set < tournaments[{{ tournament_index }}]["n_sets"]; set++) {
                        set_cell = inner_row.insertCell();
                        let form = document.createElement("input");
                        form.setAttribute("type", "text");
                        form.setAttribute("size", 1);
                        score = bets[key]["score"];
                        if (score != null && score[set] != undefined) {
                            if (score[set][0] == -1) {
                                form.value = "A-";
                            } else if (score[set][1] == -1) {
                                form.value += "-A";
                            } else if (score[set][0] < 10 && score[set][1] < 10) {
                                form.value = String(score[set][0]) + String(score[set][1]);
                            } else {
                                form.value = String(score[set][0]) + "-" + String(score[set][1]);
                            }
                        }
                        forms[key][set] = form;
                        set_cell.appendChild(form);
                    }
                    score_cell.appendChild(inner_table);
                } else {
                    // mobile
                    let form = document.createElement("input");
                    form.setAttribute("type", "text");
                    form.setAttribute("size", 3 * tournaments[{{ tournament_index }}]["n_sets"]);
                    score = bets[key]["score"];
                    if (score != null) {
                        form.value = formatScoreForm(score);
                    }
                    forms[key] = form;
                    score_cell.appendChild(form);
                }
                if (bets["joker"] == null || !matches[bets["joker"]]["bets_closed"]) {
                    let checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkboxes[key] = checkbox;
                    checkbox.setAttribute("id", key)
                    checkbox.onchange = checkbox_change;
                    joker_cell.appendChild(checkbox);
                    if (bets["joker"] == key) {
                        checkbox.checked = true;
                    }
                }
            }
        }
    }
    function checkbox_change(event) {
        id = event.target['id'];
        if (checkboxes[id].checked) {
            for (var key in checkboxes) {
                if (key != id) {
                    checkboxes[key].checked = false;
                }
            }
        }
    }
    function sendBets() {
        const re_score_minus = /^([0-9]*)-([0-9]*)$/;
        const re_score_simple = /^([0-9])([0-9])$/;
        put_json = Object();
        all_bets = Object();
        for (var key in forms) {
            if (!window.mobileCheck()) {
                // desktop
                set_scores = Array();
                for (set in forms[key]) {
                    set_scores.push(forms[key][set].value.trim());
                }
            } else {
                // mobile
                set_scores = forms[key].value.trim().split(/\s+/);
            }
            last_set = false;
            match_score = Array();
            for (set in set_scores) {
                set_score = set_scores[set];
                if (set_score != "" && last_set) {
                    alert("Punteggio non valido nel match " + key + ": set dopo un set vuoto");
                    return;
                }
                if (set_score == "") {
                    last_set = true;
                    continue;
                } else if (set_score == "-A") {
                    set_score = Array(0, -1);
                    match_score.push(set_score);
                    last_set = true;
                    continue;
                } else if (set_score == "A-") {
                    set_score = Array(-1, 0);
                    match_score.push(set_score);
                    last_set = true;
                    continue;
                } else if (re_score_minus.test(set_score)) {
                    set_score_array = set_score.match(re_score_minus).slice(1, 3);
                } else if (re_score_simple.test(set_score)) {
                    set_score_array = set_score.match(re_score_simple).slice(1, 3);
                } else {
                    alert("Punteggio non valido nel match " + key + ": " + set_score);
                    return;
                }
                set_score_array[0] = parseInt(set_score_array[0]);
                set_score_array[1] = parseInt(set_score_array[1]);
                match_score.push(set_score_array);
            }
            var joker = key in checkboxes && checkboxes[key].checked;
            all_bets[key] = Object();
            all_bets[key]["bet"] = Object();
            all_bets[key]["bet"]["score"] = match_score;
            all_bets[key]["bet"]["joker"] = joker;
        }
        all_promises = Array();
        for (key in all_bets) {
            all_promises.push(sendBetRequest(key, all_bets[key]));
        }
        Promise.allSettled(all_promises).then(function (results) {
            var restore = true;
            console.warn(results);
            for (var index in results) {
                if (results[index]["status"] == "fulfilled") {
                    match_id = results[index]["value"]["match_id"];
                    bet = JSON.parse(results[index]["value"]["response"]);
                    bets[match_id]["score"] = bet["score"];
                    if (bet["joker"]) {
                        bets["joker"] = match_id;
                    }
                } else {
                    match_id = results[index]["reason"]["match_id"];
                    message = results[index]["reason"]["response"];
                    window.alert("Match " + match_id + ": " + message);
                    restore = false;
                }
            }
            if (restore) {
                restoreMatches();
            }
        });
    }
    function restoreMatches() {
        button = document.getElementById("betsButton");
        button.innerText = "Cambia i punteggi";
        button.onclick = insertBets;
        document.getElementById("cancelButton").remove();
        forms = Object();
        checkboxes = Object();
        updateMatches();
    }
    function sendBetRequest(match_id, bet) {
        return new Promise(function (resolve, reject) {
            var betPutRequest = new XMLHttpRequest();
            betPutRequest.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve({"match_id": match_id, "response": this.responseText});
                    } else {
                        reject({"match_id": match_id, "response": this.responseText});
                    }
                }
            };
            betPutRequest.open("PUT", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/gamblers/{{ gambler_index }}/matches/" + match_id, true);
            betPutRequest.setRequestHeader("Content-Type", "application/json");
            betPutRequest.send(JSON.stringify(bet));
        })
    }
    {% endif %}
</script>
{% endblock %}

{% block content %}
<h1 id="mainHeader"></h1>
<h2 id="subHeader"></h2>
{% if is_privileged %}
<button id="betsButton" onclick="insertBets()">Cambia i punteggi</button>
{% endif %}
<h2 id="pointsHeader"></h2>
<div>
    <table class="styled-table">
        <thead>
        <tr>
            <td>Match</td>
            <td>Giocatore 1</td>
            <td>Giocatore 2</td>
            <td>Pronostico</td>
            <td>Jolly</td>
            <td>Punti</td>
        </tr>
        </thead>
        <tbody id="matches">
        </tbody>
    </table>
</div>
{% endblock %}
