{% extends "base.html" %}

{% block title_content %}
    <title></title>
{% endblock %}

{% block script_content %}
<script>
    window.onload = updatePage;
    window.mobileCheck = function() {
        let check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
    };
    var leagues;
    var gamblers;
    var players;
    var nations;
    var ranking;
    var tournamentInfo;
    var tournamentPlayers;
    var matches;
    function callLeagues() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/leagues", true);
            getRequest.send();
        })
    }
    function callGamblers() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/gamblers", true);
            getRequest.send();
        })
    }
    function callPlayers() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/players", true);
            getRequest.send();
        })
    }
    function callNations() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/nations", true);
            getRequest.send();
        })
    }
    function callRanking() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/ranking", true);
            getRequest.send();
        })
    }
    function callTournamentInfo() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}", true);
            getRequest.send();
        })
    }
    function callTournamentPlayers() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/players", true);
            getRequest.send();
        })
    }
    function callMatches() {
        return new Promise(function(resolve, reject) {
            var getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.responseText);
                    } else {
                        reject(this.responseText);
                    }
                }
            };
            getRequest.open("GET", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/matches", true);
            getRequest.send();
        })
    }
    function updatePage() {
        Promise.all([callLeagues(), callGamblers(), callPlayers(), callNations(), callRanking(), callTournamentInfo(), callTournamentPlayers(), callMatches()]).then(function (values) {
            leagues = JSON.parse(values[0]);
            gamblers = JSON.parse(values[1]);
            players = JSON.parse(values[2]);
            nations = JSON.parse(values[3]);
            ranking = JSON.parse(values[4]);
            tournamentInfo = JSON.parse(values[5]);
            tournamentPlayers = JSON.parse(values[6]);
            matches = JSON.parse(values[7]);
            updateTitles();
            updateInfo();
            updateMatches();
            updateTableRanking();
            {% if is_privileged %}
                updateTablePlayers();
            {% endif %}
        }).catch(function (reason) {
            window.alert(reason);
        });
    }
    function updateTitles() {
        mainHeader = document.getElementById("mainHeader");
        mainHeader.innerText = tournamentInfo["name"] + "  " + tournamentInfo["year"];
        if (tournamentInfo["is_ghost"]) {
            mainHeader.innerText += " [ GHOST ]";
        }
        subHeaderLink = document.createElement("a");
        subHeaderLink.innerText = leagues[{{ league_index }}]["name"];
        subHeaderLink.setAttribute("href", "/web/leagues/{{ league_index }}");
        subHeader = document.getElementById("subHeader");
        subHeader.innerHTML = "";
        subHeader.appendChild(subHeaderLink);
        document.title = tournamentInfo["name"] + "  " + tournamentInfo["year"];
    }
    function updateInfo() {
        {% if is_privileged %}
            closeButton = document.getElementById("closeButton");
            playersButton = document.getElementById("playersButton");
            scoresButton = document.getElementById("scoresButton");
            if (!tournamentInfo["is_open"]) {
                closeButton.innerText = "Apri il torneo";
                closeButton.onclick = openTournament;
                playersButton.disabled = true;
                scoresButton.disabled = true;
            } else {
                closeButton.innerText = "Chiudi il torneo";
                closeButton.onclick = closeTournament;
                playersButton.disabled = false;
                scoresButton.disabled = false;
            }
        {% endif %}
    }
    function updateMatches() {
        if (tournamentInfo["is_ghost"]) {
            table = document.getElementById("matches");
            table.innerText = "";
            scoresButton = document.getElementById("scoresButton");
            scoresButton.hidden = true;
            return;
        }
        table = document.getElementById("tableMatchesBody");
        table.innerText = "";
        for (var key in matches) {
            const row = table.insertRow();
            const id_cell = row.insertCell();
            id_cell.innerText = key;
            if (matches[key]["bets_closed"]) {
                let lock = document.createElement("img");
                lock.src = "/static/lock.png";
                id_cell.innerText += "   ";
                id_cell.appendChild(lock);
            } else {
                any_open_match = true;
            }
            if (matches[key]["timestamp"] != null) {
                let clock = document.createElement("img");
                clock.src = "/static/clock.png";
                id_cell.innerText += "   ";
                id_cell.appendChild(clock);
            }
            const player_1_cell = row.insertCell();
            const player_2_cell = row.insertCell();
            const score_cell = row.insertCell();
            const dummy_cell = row.insertCell();
            if (matches[key]["players"]["player_1"] == null || matches[key]["players"]["player_2"] == null) {
                continue;
            }
            if (matches[key]["winner"] == matches[key]["players"]["player_1"]) {
                winner = 1;
            } else if (matches[key]["winner"] == matches[key]["players"]["player_2"]) {
                winner = 2;
            } else {
                winner = null;
            }
            if (winner == 1) {
                player_1_cell.className = "bold";
            }
            seed_player_1 = getSeed(matches[key]["players"]["player_1"]);
            if (seed_player_1 != 0) {
                seed_string = " [" + seed_player_1 + "]";
            } else {
                seed_string = "";
            }
            player_1_cell.innerText = players[matches[key]["players"]["player_1"]]["surname"] + seed_string;
            if (winner == 2) {
                player_2_cell.className = "bold";
            }
            seed_player_2 = getSeed(matches[key]["players"]["player_2"]);
            if (seed_player_2 != 0) {
                seed_string = " [" + seed_player_2 + "]";
            } else {
                seed_string = "";
            }
            player_2_cell.innerText = players[matches[key]["players"]["player_2"]]["surname"] + seed_string;
            score_cell.innerText = formatScore(matches[key]["score"]);
            dummy_cell.innerText = "";
        }
    }
    function getSeed(player) {
        for (key in tournamentPlayers) {
            if (tournamentPlayers[key] == null) {
                continue;
            }
            index = tournamentPlayers[key]["index"];
            if (index == player) {
                return tournamentPlayers[key]["seed"];
            }
        }
    }
    function formatScore(score) {
        formatted = "";
        for (set in score) {
            if (score[set][0] == -1) {
                formatted += "A- " + " / ";
            } else if (score[set][1] == -1) {
                formatted += " -A" + " / ";
            }
            else {
                formatted += score[set][0] + "-" + score[set][1] + " / ";
            }
        }
        return formatted.slice(0, -2);
    }
    function formatScoreForm(score) {
        formatted = "";
        for (set in score) {
            if (score[set][0] == -1) {
                formatted += "A- ";
            } else if (score[set][1] == -1) {
                formatted += "-A ";
            } else if (score[set][0] < 10 && score[set][1] < 10) {
                formatted += String(score[set][0]) + String(score[set][1]) + " ";
            } else {
                formatted += score[set][0] + "-" + score[set][1] + " ";
            }
        }
        return formatted;
    }
    function updateTableRanking() {
        if (tournamentInfo["is_ghost"]) {
            table = document.getElementById("ranking");
            table.innerText = "";
            return;
        }
        table = document.getElementById("tableRankingBody");
        table.innerText = "";
        scores = ranking["tournament_scores"];
        ranking_scores = ranking["tournament_ranking_scores"];
        scores_array = Object.entries(scores);
        scores_array.sort(function (first_pair, second_pair) {
            return first_pair[1] - second_pair[1];
        });
        scores_array.reverse();
        var last_position = undefined;
        var last_points = undefined;
        for (index = 0; index < scores_array.length; index++) {
            const pair = scores_array[index];
            const gambler_index = pair[0];
            const gambler_points = pair[1];
            const row = table.insertRow();
            const position_cell = row.insertCell();
            if (gambler_points == last_points) {
                position_cell.innerText = last_position;
            } else {
                position_cell.innerText = index + 1;
                last_position = index + 1;
            }
            const gambler_cell = row.insertCell();
            const gambler_link = document.createElement("a");
            gambler_link.innerText = gamblers[gambler_index]["nickname"];
            gambler_link.setAttribute("href", "/web/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/gamblers/" + pair[0]);
            gambler_cell.appendChild(gambler_link);
            const points_cell = row.insertCell();
            points_cell.innerText = gambler_points;
            const ranking_points_cell = row.insertCell();
            ranking_points_cell.innerText = ranking_scores[gambler_index];
            last_points = gambler_points;
        }
    }
    {% if is_privileged %}
        seedForms = Object();
        playerForms = Object();
        function insertPlayers() {
            playersButton = document.getElementById("playersButton");
            playersButton.innerText = "Manda i tennisti";
            playersButton.onclick = sendPlayers;
            scoresButton = document.getElementById("scoresButton");
            scoresButton.disabled = true;
            closeButton = document.getElementById("closeButton");
            closeButton.disabled = true;
            cancelButton = document.createElement("button");
            cancelButton.id = "cancelButton";
            cancelButton.innerText = "Annulla";
            cancelButton.onclick = restorePlayers;
            playersButton.parentNode.insertBefore(cancelButton, playersButton.nextSibling);
            table = document.getElementById("tablePlayersBody");
            table.innerText = "";
            if (tournamentInfo["draw_type"] == "Draw16") {
                playersNumber = 16;
            } else if (tournamentInfo["draw_type"] == "DrawRoundRobin") {
                playersNumber = 12;
            }
            for (index = 0; index < playersNumber; index++) {
                playerObject = tournamentPlayers[index];
                player_index = playerObject["index"];
                if (player_index == -1) {
                    player_surname = "/";
                } else {
                    player_surname = players[player_index]["surname"];
                }
                seed = playerObject["seed"];
                const row = table.insertRow();
                const position_cell = row.insertCell();
                position_cell.innerText = index + 1;
                const player_cell = row.insertCell();
                let form_player = document.createElement("select");
                form_player.onchange = playerChange;
                option = document.createElement("option");
                option.value = -1;
                option.innerText = "";
                form_player.appendChild(option);
                for (key in players) {
                    option = document.createElement("option");
                    option.value = key;
                    option.innerText = players[key]["surname"];
                    form_player.appendChild(option);
                }
                player_cell.appendChild(form_player);
                playerForms[index] = form_player;
                form_player.value = player_index;
                const seed_cell = row.insertCell();
                let seedForm = document.createElement("input");
                seedForm.setAttribute("type", "text");
                seedForm.setAttribute("size", 1);
                if (seed != 0) {
                    seedForm.value = seed;
                } else {
                    seedForm.value = "";
                }
                if (player_index == 0 || player_index == -1) {
                    seedForm.disabled = true;
                }
                seed_cell.appendChild(seedForm);
                seedForms[index] = seedForm;
            }
        }
        function playerChange(event) {
            changedForm = event.target;
            let newPlayer = changedForm.value;
            if (newPlayer == 0 || newPlayer == -1) {
                for (let index in playerForms) {
                    playerForm = playerForms[index];
                    if (changedForm == playerForm) {
                        seedForms[index].value = "";
                        seedForms[index].disabled = true;
                        break;
                    }
                }
                return;
            }
            for (let index in playerForms) {
                playerForm = playerForms[index];
                if (changedForm == playerForm) {
                    seedForms[index].disabled = false;
                    continue;
                }
                if (playerForm.value == newPlayer) {
                    playerForm.value = -1;
                    seedForms[index].value = "";
                    seedForms[index].disabled = true;
                }
            }
        }
        function sendPlayers() {
            all_players = Object();
            all_seeds = Array();
            for (var index in playerForms) {
                player_index = playerForms[index].value;
                const re_seed = /^([0-9]*)$/;
                seed_value = seedForms[index].value;
                if (re_seed.test(seed_value)) {
                    seed = seed_value.match(re_seed).slice(1, 3);
                    if (seed == "") {
                        seed = 0;
                    } else {
                        seed = parseInt(seed);
                    }
                    if (seed != 0 && all_seeds.includes(seed)) {
                        window.alert("Seed duplicato nel posto " + index + ": " + seed_value);
                        return;
                    }
                    all_seeds.push(seed);
                } else {
                    window.alert("Seed non valido nel posto " + index + ": " + seed_value);
                    return;
                }
                if (player_index == tournamentPlayers[index]["index"] && seed == tournamentPlayers[index]["seed"]) {
                    continue;
                }
                player_seed = Object();
                player_seed["player_seed"] = Object();
                player_seed["player_seed"]["player_index"] = player_index;
                player_seed["player_seed"]["seed"] = seed;
                all_players[index] = player_seed;
            }
            all_reset_promises = Array();
            reset_player_seed = Object();
            reset_player_seed["player_seed"] = Object();
            reset_player_seed["player_seed"]["player_index"] = -1;
            reset_player_seed["player_seed"]["seed"] = 0;
            for (let place in all_players) {
                all_reset_promises.push(sendPlayerRequest(place, reset_player_seed));
            }
            Promise.allSettled(all_reset_promises).then(function (results) {
                for (var index in results) {
                    if (results[index]["status"] != "fulfilled") {
                        message = results[index]["reason"]["response"];
                        window.alert("Attenzione: " + message);
                        return;
                    }
                }
            });
            all_promises = Array();
            for (let place in all_players) {
                all_promises.push(sendPlayerRequest(place, all_players[place]));
            }
            Promise.allSettled(all_promises).then(function (results) {
                var restore = true;
                for (var index in results) {
                    if (results[index]["status"] == "fulfilled") {
                        place = results[index]["value"]["place"]
                        response = JSON.parse(results[index]["value"]["response"]);
                        tournamentPlayers[place] = response;
                    } else {
                        message = results[index]["reason"]["response"];
                        window.alert("Attenzione: " + message);
                        restore = false;
                    }
                }
                if (restore) {
                    restorePlayers();
                }
            });
        }
        function sendPlayerRequest(place, player_object) {
            return new Promise(function (resolve, reject) {
                var putRequest = new XMLHttpRequest();
                putRequest.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            resolve({"place": place, "response": this.responseText});
                        } else {
                            reject({"place": place, "response": this.responseText});
                        }
                    }
                };
                putRequest.open("PUT", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/players/" + place, true);
                putRequest.setRequestHeader("Content-Type", "application/json");
                putRequest.send(JSON.stringify(player_object));
            })
        }
        function restorePlayers() {
            playersButton = document.getElementById("playersButton");
            playersButton.innerText = "Cambia i tennisti";
            playersButton.onclick = insertPlayers;
            scoresButton = document.getElementById("scoresButton");
            scoresButton.disabled = false;
            closeButton = document.getElementById("closeButton");
            closeButton.disabled = false;
            document.getElementById("cancelButton").remove();
            playersForms = Array();
            seedForms = Array();
            updateTablePlayers();
        }
        function updateTablePlayers() {
            if (tournamentInfo["is_ghost"]) {
                table = document.getElementById("players");
                table.innerText = "";
                playersButton = document.getElementById("playersButton");
                playersButton.hidden = true;
                return;
            }
            table = document.getElementById("tablePlayersBody");
            table.innerText = "";
            if (tournamentInfo["draw_type"] == "Draw16") {
                playersNumber = 16;
            } else if (tournamentInfo["draw_type"] == "DrawRoundRobin") {
                playersNumber = 12;
            }
            for (index = 0; index < playersNumber; index++) {
                playerObject = tournamentPlayers[index];
                player_index = playerObject["index"];
                if (player_index == -1) {
                    player_surname = "/";
                } else {
                    player_surname = players[tournamentPlayers[index]["index"]]["surname"];
                }
                seed = tournamentPlayers[index]["seed"];
                const row = table.insertRow();
                const position_cell = row.insertCell();
                position_cell.innerText = index + 1;
                const player_cell = row.insertCell();
                player_cell.innerText = player_surname;
                const seed_cell = row.insertCell();
                if (seed != 0) {
                    seed_cell.innerText = seed;
                } else {
                    seed_cell.innerText = "";
                }
            }
        }
        var forms = Object();
        var checkboxes = Object();
        var datetimes = Object();
        function insertScores() {
            scoresButton = document.getElementById("scoresButton");
            scoresButton.innerText = "Manda i punteggi";
            scoresButton.onclick = sendScores;
            playersButton = document.getElementById("playersButton");
            playersButton.disabled = true;
            closeButton = document.getElementById("closeButton");
            closeButton.disabled = true;
            cancelButton = document.createElement("button");
            cancelButton.id = "cancelButton";
            cancelButton.innerText = "Annulla";
            cancelButton.onclick = restoreMatches;
            scoresButton.parentNode.insertBefore(cancelButton, scoresButton.nextSibling);
            table = document.getElementById("tableMatchesBody");
            table.innerText = "";
            for (var key in matches) {
                const row = table.insertRow();
                const id_cell = row.insertCell();
                id_cell.innerText = key;
                if (matches[key]["bets_closed"]) {
                    lock = document.createElement("img");
                    lock.src = "/static/lock.png";
                    id_cell.innerText += "   ";
                    id_cell.appendChild(lock);
                }
                const player_1_cell = row.insertCell();
                const player_2_cell = row.insertCell();
                const score_cell = row.insertCell();
                const bets_closed_cell = row.insertCell();
                const bets_closed_time_cell = row.insertCell();
                if (matches[key]["players"]["player_1"] == null || matches[key]["players"]["player_2"] == null) {
                    continue;
                }
                seed_player_1 = getSeed(matches[key]["players"]["player_1"]);
                if (seed_player_1 != 0) {
                    seed_string = " [" + seed_player_1 + "]";
                } else {
                    seed_string = "";
                }
                player_1_cell.innerText = players[matches[key]["players"]["player_1"]]["surname"] + seed_string;
                seed_player_2 = getSeed(matches[key]["players"]["player_2"]);
                if (seed_player_2 != 0) {
                    seed_string = " [" + seed_player_2 + "]";
                } else {
                    seed_string = "";
                }
                player_2_cell.innerText = players[matches[key]["players"]["player_2"]]["surname"] + seed_string;
                if (matches[key]["players"]["player_1"] == 0 || matches[key]["players"]["player_2"] == 0) {
                    continue;
                }
                inner_table = document.createElement("table");
                inner_table.setAttribute("class", "forms-table");
                inner_row = inner_table.insertRow();
                forms[key] = Object();
                if (!window.mobileCheck()) {
                    // desktop
                    score = matches[key]["score"];
                    for (var set = 0; set < tournamentInfo["n_sets"]; set++) {
                        set_cell = inner_row.insertCell();
                        let form = document.createElement("input");
                        form.setAttribute("type", "text");
                        form.setAttribute("size", 1);
                        if (score != null && score[set] != undefined) {
                            if (score[set][0] == -1) {
                                form.value = "A-";
                            } else if (score[set][1] == -1) {
                                form.value += "-A";
                            } else if (score[set][0] < 10 && score[set][1] < 10) {
                                form.value = String(score[set][0]) + String(score[set][1]);
                            } else {
                                form.value = String(score[set][0]) + "-" + String(score[set][1]);
                            }
                        }
                        forms[key][set] = form;
                        set_cell.appendChild(form);
                    }
                    score_cell.appendChild(inner_table);
                } else {
                    // mobile
                    let form = document.createElement("input");
                    form.setAttribute("type", "text");
                    form.setAttribute("size", 3 * tournamentInfo["n_sets"]);
                    score = matches[key]["score"];
                    if (score != null) {
                        form.value = formatScoreForm(score);
                    }
                    forms[key] = form;
                    score_cell.appendChild(form);
                }
                if (score == null) {
                    let checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.onclick = showDatetime;
                    checkboxes[key] = checkbox;
                    bets_closed_cell.appendChild(checkbox);
                    if (matches[key]["bets_closed"]) {
                        checkbox.checked = true;
                    }
                }
                if (score == null && !matches[key]["bets_closed"]) {
                    let datetime = document.createElement("input");
                    datetime.type = "datetime-local";
                    bets_closed_time_cell.appendChild(datetime);
                    datetime.hidden = true;
                    if (matches[key]["timestamp"] != null) {
                        datetime.value = timestamp2localtime(matches[key]["timestamp"]);
                    }
                    datetimes[key] = datetime;
                }
            }
        }
        function timestamp2localtime(timestamp) {
            var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
            return (new Date(timestamp * 1000 - tzoffset)).toISOString().slice(0, -1);
        }
        function getKeyByValue(obj, value) {
            for(var prop in obj) {
                if(obj.hasOwnProperty(prop)) {
                    if(obj[prop] === value)
                        return prop;
                }
            }
        }
        function showDatetime(event) {
            key = getKeyByValue(checkboxes, event.target);
            if (event.target.checked) {
                datetimes[key].hidden = false;
            } else {
                datetimes[key].hidden = true;
            }
        }
        function getTimeStamp(value_string) {
            if (value_string == "") {
                return null;
            }
            const year = value_string.slice(0, 4);
            const month = parseInt(value_string.slice(5, 7)) - 1;
            const day = value_string.slice(8, 10);
            const hour = value_string.slice(11, 13);
            const minute = value_string.slice(14, 16);
            return new Date(year, month, day, hour, minute, '00').getTime()/1000;
        }
        function sendScores() {
            const re_score_minus = /^([0-9]*)-([0-9]*)$/;
            const re_score_simple = /^([0-9])([0-9])$/;
            all_scores = Object();
            for (var key in forms) {
                if (!window.mobileCheck()) {
                    // desktop
                    set_scores = Array();
                    for (set in forms[key]) {
                        set_scores.push(forms[key][set].value.trim());
                    }
                } else {
                    // mobile
                    set_scores = forms[key].value.trim().split(/\s+/);
                }
                last_set = false;
                match_score = Array();
                for (set in set_scores) {
                    set_score = set_scores[set];
                    if (set_score != "" && last_set) {
                        window.alert("Punteggio non valido nel match " + key + ": set dopo un set vuoto");
                        return;
                    }
                    if (set_score == "") {
                        last_set = true;
                        continue;
                    } else if (set_score == "-A") {
                        set_score = Array(0, -1);
                        match_score.push(set_score);
                        last_set = true;
                        continue;
                    } else if (set_score == "A-") {
                        set_score = Array(-1, 0);
                        match_score.push(set_score);
                        last_set = true;
                        continue;
                    } else if (re_score_minus.test(set_score)) {
                        set_score_array = set_score.match(re_score_minus).slice(1, 3);
                    } else if (re_score_simple.test(set_score)) {
                        set_score_array = set_score.match(re_score_simple).slice(1, 3);
                    } else {
                        window.alert("Punteggio non valido nel match " + key + ": " + set_score);
                        return;
                    }
                    set_score_array[0] = parseInt(set_score_array[0]);
                    set_score_array[1] = parseInt(set_score_array[1]);
                    match_score.push(set_score_array);
                }
                all_scores[key] = Object();
                all_scores[key]["score"] = match_score;
                if (key in checkboxes) {
                    var timestamp;
                    if (key in datetimes) {
                        timestamp = getTimeStamp(datetimes[key].value);
                    } else {
                        timestamp = null;
                    }
                    if (timestamp == null) {
                        all_scores[key]["bets_closed"] = checkboxes[key].checked;
                    } else {
                        all_scores[key]["bets_closed"] = false;
                    }
                    all_scores[key]["timestamp"] = timestamp;
                } else {
                    all_scores[key]["bets_closed"] = true;
                    all_scores[key]["timestamp"] = null;
                }
            }
            all_promises = Array();
            for (key in all_scores) {
                if (!equalScores(all_scores[key]["score"], matches[key]["score"]) || all_scores[key]["bets_closed"] != matches[key]["bets_closed"]
                    || all_scores[key]["timestamp"] != matches[key]["timestamp"]) {
                    all_promises.push(sendScoreRequest(key, all_scores[key]));
                }
            }
            if (all_promises.length == 0) {
                restoreMatches();
            }
            Promise.allSettled(all_promises).then(function (results) {
                var restore = true;
                successful = [];
                failed = [];
                for (var index in results) {
                    if (results[index]["status"] == "fulfilled") {
                        match_id = results[index]["value"]["match_id"];
                        match = JSON.parse(results[index]["value"]["response"]);
                        matches[match_id] = match;
                        successful_string = "Match " + match_id + " aggiornato: [ " + formatScore(match['score']) + " ]";
                        if (match['bets_closed']) {
                            successful_string += " con scommesse chiuse";
                        } else {
                            successful_string += " con scommesse aperte";
                        }
                        if (match['timestamp'] != null) {
                            successful_string += " con chiusura programmata per " + timestamp2localtime(match["timestamp"]).slice(0, -4);
                        }
                        successful.push(successful_string);
                    } else {
                        match_id = results[index]["reason"]["match_id"];
                        message = results[index]["reason"]["response"];
                        failed.push("Attenzione! Match " + match_id + ": " + message);
                        restore = false;
                    }
                }
                if (successful.length > 0) {
                    window.alert(successful.join("\n"));
                }
                if (failed.length > 0) {
                    window.alert(failed.join("\n"));
                }
                if (restore) {
                    restoreMatches();
                }
            });
        }
        function equalScores(score1, score2) {
            if (score2 == null) {
                return score1.length == 0;
            }
            return equalArrays(score1, score2);
        }
        function equalArrays(a1, a2) {
            var i = a1.length;
            if (i != a2.length) {
                return false;
            }
            while (i--) {
                if (Array.isArray(a1[i]) && Array.isArray(a2[i])) {
                    if (!equalArrays(a1[i], a2[i])) {
                        return false;
                    }
                } else if (a1[i] != a2[i]) {
                    return false;
                }
            }
            return true;
        }
        function restoreMatches() {
            scoresButton = document.getElementById("scoresButton");
            scoresButton.innerText = "Cambia i punteggi";
            scoresButton.onclick = insertScores;
            playersButton = document.getElementById("playersButton");
            playersButton.disabled = false;
            closeButton = document.getElementById("closeButton");
            closeButton.disabled = false;
            document.getElementById("cancelButton").remove();
            forms = Object();
            checkboxes = Object();
            updateMatches();
        }
        function sendScoreRequest(match_id, bet) {
            return new Promise(function (resolve, reject) {
                var putRequest = new XMLHttpRequest();
                putRequest.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            resolve({"match_id": match_id, "response": this.responseText});
                        } else {
                            reject({"match_id": match_id, "response": this.responseText});
                        }
                    }
                };
                putRequest.open("PUT", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/matches/" + match_id, true);
                putRequest.setRequestHeader("Content-Type", "application/json");
                putRequest.send(JSON.stringify(bet));
            })
        }
        function sendScheduledCloseRequest(match_id, time) {
            return new Promise(function (resolve, reject) {
                var postRequest = new XMLHttpRequest();
                postRequest.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            resolve({"match_id": match_id, "response": this.responseText});
                        } else {
                            reject({"match_id": match_id, "response": this.responseText});
                        }
                    }
                };
                postRequest.open("POST", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}/matches/" + match_id + '/close', true);
                postRequest.setRequestHeader("Content-Type", "application/json");
                postRequest.send(JSON.stringify(time));
            })
        }
        function closeTournament() {
            changeTournamentStatus(false);
            for (key in matches) {
                matches[key]["bets_closed"] = true;
            }
            updateMatches();
        }
        function openTournament() {
            changeTournamentStatus(true);
        }
        function changeTournamentStatus(is_open) {
            var text;
            if (is_open) {
                text = "Il torneo verrà aperto. Continuare?";
            } else {
                text = "Il torneo verrà chiuso. Continuare?";
            }
            if (confirm(text) != true) {
                return;
            }
            requestContent = Object();
            requestContent["is_open"] = is_open;
            Promise.all([sendStatusRequest(requestContent)]).then(function (values) {
                tournamentInfo = JSON.parse(values[0]);
                updateInfo();
                Promise.all([callRanking()]).then(function (values) {
                    ranking = JSON.parse(values[0]);
                    updateTableRanking();
                }).catch(function (reason) {
                    window.alert(reason);
                });
            }).catch(function (reason) {
                window.alert(reason);
            });
        }
        function sendStatusRequest(is_open) {
            return new Promise(function (resolve, reject) {
                var putRequest = new XMLHttpRequest();
                putRequest.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            resolve(this.responseText);
                        } else {
                            reject(this.responseText);
                        }
                    }
                };
                putRequest.open("PUT", "/leagues/{{ league_index }}/tournaments/{{ tournament_index }}", true);
                putRequest.setRequestHeader("Content-Type", "application/json");
                putRequest.send(JSON.stringify(is_open));
            })
        }
    {% endif %}
</script>
{% endblock %}

{% block content %}
<h1 id="mainHeader"></h1>
<h2 id="subHeader"></h2>
{% if is_privileged %}
    <button id="scoresButton" onclick="insertScores()">Cambia i punteggi</button>
    <button id="closeButton" onclick="closeTournament()">Chiudi il torneo</button>
{% endif %}
<div class="floatRankings">
    <table id="matches" class="styled-table">
        <thead>
        <tr>
            <td>Match</td>
            <td>Giocatore 1</td>
            <td>Giocatore 2</td>
            <td>Risultato</td>
            <td></td>
            <td></td>
        </tr>
        </thead>
        <tbody id="tableMatchesBody">
        </tbody>
    </table>
</div>
<div class="floatRankings">
    <table id="ranking" class="styled-table">
        <thead>
        <tr>
            <td>Posizione</td>
            <td>Scommettitore</td>
            <td>Punti</td>
            <td>Punti ranking</td>
        </tr>
        </thead>
        <tbody id="tableRankingBody">
        </tbody>
    </table>
</div>
    {% if is_privileged %}
        <div class="floatRankings">
            <button id="playersButton" onclick="insertPlayers()">Cambia i tennisti</button>
            <table id="players" class="styled-table">
                <thead>
                <tr>
                    <td>Posto</td>
                    <td>Tennista</td>
                    <td>Seed</td>
                </tr>
                </thead>
                <tbody id="tablePlayersBody">
                </tbody>
            </table>
        </div>
    {% endif %}
{% endblock %}
